<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pathfinding… · Jungle Mode</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: {
            jungle: {
              900: '#010503',
              800: '#041208'
            },
            forest: {
              200: '#d9ffe9',
              400: '#2ee06a'
            }
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      font-family:"Inter",Segoe UI,system-ui,-apple-system,Helvetica,Arial,sans-serif;
      min-height:100vh;
      background:radial-gradient(circle at top,#0f4024 0%,rgba(0,0,0,0) 55%),#010503;
      color:#e4f9ec;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-jungle-900 via-black to-jungle-800 px-6 py-10 text-forest-200">
  <div class="mx-auto max-w-6xl">
    <h1 class="text-3xl font-semibold text-white">Animating search…</h1>
    <div class="mt-2 text-sm text-forest-200/80">Job ID: <code class="text-forest-200">{{ jobId }}</code></div>
    <div class="mt-6 grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(280px,1fr)]">
      <div class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl backdrop-blur-xl">
        <img id="frame" src="/jungle/image/{{ jobId }}/current.png?ts={{ ts }}" alt="Current frame" class="w-full rounded-2xl border border-white/10" />
        <div id="phase" class="mt-4 inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/30 px-4 py-2 text-xs font-semibold uppercase tracking-[0.4em] text-forest-200">Waiting for frames…</div>
      </div>
      <div class="rounded-3xl border border-white/10 bg-black/40 p-6 shadow-2xl backdrop-blur-xl">
        <strong class="text-white">Live logs</strong>
        <pre id="logs" class="mt-4 h-[420px] overflow-auto rounded-2xl border border-white/10 bg-black/60 p-4 text-sm text-forest-200">Connecting…</pre>
      </div>
    </div>
  </div>

  <script>
    const jobId = "{{ jobId }}";
    const frameEl = document.getElementById('frame');
    const logsEl = document.getElementById('logs');
    const phaseEl = document.getElementById('phase');

    function appendLog(message){
      const ts = new Date().toLocaleTimeString();
      logsEl.textContent += `\n[${ts}] ${message}`;
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    function refreshFrame(){
      frameEl.src = `/jungle/image/${jobId}/current.png?ts=${Date.now()}`;
    }

    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${wsProtocol}://${window.location.host}/jungle/ws/${jobId}`;
    let ws;
    try{
      ws = new WebSocket(wsUrl);
    }catch(err){
      appendLog('WebSocket init failed, falling back to polling.');
    }

    if(ws){
      ws.onmessage = (event)=>{
        try{
          const data = JSON.parse(event.data);
          if(data.type === 'log'){
            appendLog(data.msg);
          }else if(data.type === 'frame'){
            refreshFrame();
            phaseEl.textContent = 'Exploring…';
          }else if(data.type === 'done'){
            phaseEl.textContent = 'Finalizing';
            setTimeout(checkStatus, 1200);
          }
        }catch(err){
          appendLog('Malformed WS payload.');
        }
      };
      ws.onerror = ()=> appendLog('WebSocket error, will keep trying.');
    }

    async function checkStatus(){
      try{
        const res = await fetch(`/jungle/status/${jobId}`);
        if(!res.ok){
          appendLog('Status check failed.');
          return;
        }
        const data = await res.json();
        if(data.error){
          appendLog(`Error: ${data.error}`);
          phaseEl.textContent = 'Errored';
          return;
        }
        if(data.done){
          phaseEl.textContent = 'Completed';
          window.location.href = `/jungle/result/${jobId}`;
        }
      }catch(err){
        appendLog('Status fetch failed.');
      }
    }

    setInterval(checkStatus, 2500);
  </script>
</body>
</html>
